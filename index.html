<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Input Data Admin</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: #2d3748;
      height: 100%;
      overflow-x: hidden;
    }

    /* Login Container */
    .login-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .login-container.show {
      display: flex;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      position: relative;
    }

    .login-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .login-logo {
      width: 60px;
      height: 60px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .login-title {
      font-size: 24px;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .login-subtitle {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
    }

    .login-error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 14px;
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 5000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      max-height: 95%;
      min-height: 500px;
      overflow-y: auto;
      position: relative;
      margin: auto;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      border-radius: 16px 16px 0 0;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #2d3748;
    }

    .modal-close {
      background: #f56565;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #e53e3e;
      transform: scale(1.1);
    }

    .modal-body {
      padding: 24px;
    }

    .admin-panel {
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
    }

    .admin-panel.show {
      display: flex;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-avatar {
      width: 40px;
      height: 40px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .admin-name {
      font-weight: 600;
      color: #2d3748;
    }

    .btn-logout {
      background: #f56565;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: #e53e3e;
      transform: translateY(-1px);
    }

    .btn-add-container {
      display: none;
    }

    .btn-add {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .public-view {
      display: block;
    }

    .public-view.hide {
      display: none;
    }

    * {
      box-sizing: border-box;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      justify-content: space-between;
    }

    .header-logo {
      width: 64px;
      height: 64px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .header-text {
      text-align: left;
    }

    .header h1 {
      margin: 0;
      font-size: 32px;
      color: #3b82f6;
      font-weight: bold;
    }

    .btn-login-header {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-login-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .tabs-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .tabs {
      display: flex;
      background: #f7fafc;
      border-bottom: 2px solid #e2e8f0;
      overflow-x: auto;
      flex-wrap: nowrap;
    }

    .tab {
      padding: 16px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 600;
      color: #718096;
      transition: all 0.3s;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      background: #edf2f7;
      color: #3b82f6;
    }

    .tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      background: white;
    }

    .tab-content {
      display: none;
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .tab-content.active {
      display: block;
    }

    .tab-add-buttons {
      display: none;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-add-buttons.show {
      display: flex;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .saldo-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .saldo-card {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      padding: 20px;
      border-radius: 12px;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .saldo-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .saldo-value {
      font-size: 28px;
      font-weight: bold;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .history-table th {
      background: #f7fafc;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #4a5568;
      font-size: 13px;
      border-bottom: 2px solid #e2e8f0;
    }

    .history-table td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 13px;
    }

    .history-table tr:hover {
      background: #f7fafc;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-message {
      background: #48bb78;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #f56565;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .checkbox-item:hover:not(.paid) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* CHECKED (user pilih sekarang) = Background REDUP + Tulisan/Centang TERANG */
    .checkbox-item.checked:not(.paid) {
      border: 2px solid;
      font-weight: 600;
    }

    /* DISABLED (sudah dibayar) = SEMUA REDUP */
    .checkbox-item.paid {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .checkbox-item.paid input[type="checkbox"] {
      cursor: not-allowed;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      flex: 1;
    }

    .checkbox-item.paid label {
      cursor: not-allowed;
    }

    /* Warna per tahun - DEFAULT TERANG (belum dibayar) */
    .checkbox-item.year-2025 {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
      color: white;
      border-color: #FF3838;
    }
    /* User pilih = Background REDUP + Tulisan TERANG */
    .checkbox-item.year-2025.checked:not(.paid) {
      background: linear-gradient(135deg, #FFE5E5 0%, #FFD1D1 100%);
      color: #FF3838;
      border-color: #FF3838;
    }

    .checkbox-item.year-2026 {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border-color: #0D47A1;
    }
    .checkbox-item.year-2026.checked:not(.paid) {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      color: #0D47A1;
      border-color: #0D47A1;
    }

    .checkbox-item.year-2027 {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border-color: #6A1B9A;
    }
    .checkbox-item.year-2027.checked:not(.paid) {
      background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
      color: #6A1B9A;
      border-color: #6A1B9A;
    }

    .checkbox-item.year-2028 {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border-color: #E65100;
    }
    .checkbox-item.year-2028.checked:not(.paid) {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
      color: #E65100;
      border-color: #E65100;
    }

    .checkbox-item.year-2029 {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border-color: #2E7D32;
    }
    .checkbox-item.year-2029.checked:not(.paid) {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32;
      border-color: #2E7D32;
    }

    .checkbox-item.year-2030 {
      background: linear-gradient(135deg, #FFEB3B 0%, #FDD835 100%);
      color: #333;
      border-color: #F9A825;
    }
    .checkbox-item.year-2030.checked:not(.paid) {
      background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
      color: #F9A825;
      border-color: #F9A825;
    }
    
    .payment-summary {
      background: #f7fafc;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .payment-summary-title {
      font-size: 16px;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .payment-calculation {
      font-size: 18px;
      color: #3b82f6;
      font-weight: bold;
      margin-bottom: 12px;
    }
    
    .payment-months {
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .payment-months strong {
      color: #2d3748;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn-cancel {
      background: #718096;
      color: white;
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-cancel:hover {
      background: #4a5568;
      transform: translateY(-2px);
    }

    .footer {
      background: white;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
      text-align: center;
      font-size: 13px;
      color: #718096;
    }

    .iuran-summary-boxes {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .iuran-summary-box {
      padding: 16px 20px;
      border-radius: 12px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 200px;
      flex: 1;
    }

    .iuran-summary-label {
      font-size: 12px;
      opacity: 0.95;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .iuran-summary-value {
      font-size: 20px;
      font-weight: bold;
      word-break: break-word;
    }

    .select-warga-section {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
    }

    .warga-dropdown {
      display: none;
      position: absolute;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      width: calc(100% - 40px);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-top: 4px;
    }

    .warga-dropdown.show {
      display: block;
    }

    .warga-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f7fafc;
      transition: background 0.2s;
    }

    .warga-item:hover {
      background: #edf2f7;
    }

    .warga-item:last-child {
      border-bottom: none;
    }

    .warga-item-name {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .warga-item-detail {
      font-size: 12px;
      color: #718096;
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 12px;
      }

      .header {
        padding: 16px;
        flex-wrap: wrap;
      }

      .header-logo {
        width: 50px;
        height: 50px;
      }

      .header h1 {
        font-size: 18px;
      }

      .header-subtitle {
        font-size: 11px;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab {
        padding: 14px 8px;
        font-size: 11px;
        flex: 0 0 50%;
        width: 50%;
        text-align: center;
        border-bottom: 3px solid transparent;
      }

      .tab.active {
        border-bottom-color: #3b82f6;
      }

      .tab-content {
        padding: 16px;
      }

      .saldo-container {
        grid-template-columns: 1fr;
      }

      .history-table {
        font-size: 11px;
      }

      .history-table th,
      .history-table td {
        padding: 8px 4px;
      }

      .checkbox-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .btn-login-header {
        font-size: 12px;
        padding: 8px 16px;
      }

      .admin-panel {
        flex-wrap: wrap;
        gap: 12px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Login Modal -->
  <div id="loginModal" class="login-container">
   <div class="login-box">
    <div class="login-header">
     <div class="login-logo">
      <svg width="30" height="30" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /> <path d="M9 22V12H15V22" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
     </div>
     <div>
      <div class="login-title">
       Login Admin
      </div>
      <div class="login-subtitle">
       Sistem Manajemen Warga RT 01 RW VIII
      </div>
     </div>
    </div>
    <div id="loginError" class="login-error"></div>
    <form id="loginForm" onsubmit="handleLogin(event)">
     <div class="form-group"><label for="adminUsername">Username</label> <input type="text" id="adminUsername" required autocomplete="username">
     </div>
     <div class="form-group"><label for="adminPassword">Password</label> <input type="password" id="adminPassword" required autocomplete="current-password">
     </div><button type="submit" class="btn btn-primary" id="btnLogin" style="width: 100%;"> Masuk </button>
    </form>
   </div>
  </div><!-- Modal untuk Form Input -->
  <div id="modalOverlay" class="modal-overlay">
   <div class="modal-content">
    <div class="modal-header">
     <div class="modal-title" id="modalTitle">
      Form Input
     </div><button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"><!-- Form akan di-load di sini -->
    </div>
   </div>
  </div>
  <div class="app-container">
   <header class="header">
    <div style="display: flex; align-items: center; gap: 20px;">
     <div class="header-logo">
      <svg width="32" height="32" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /> <path d="M9 22V12H15V22" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
     </div>
     <div class="header-text">
      <h1 id="appTitle">INPUT DATA ADMIN</h1>
     </div>
    </div>
    <div><button id="btnLoginHeader" class="btn-login-header" onclick="showLoginModal()"> üîê Login Admin </button>
     <div id="adminPanel" class="admin-panel">
      <div class="admin-info">
       <div class="admin-avatar" id="adminAvatar">
        A
       </div>
       <div>
        <div class="admin-name" id="adminName">
         Admin
        </div>
        <div style="font-size: 12px; color: #718096;">
         Administrator
        </div>
       </div>
      </div><button class="btn-logout" onclick="handleLogout()">Logout</button>
     </div>
    </div>
   </header>
   <main class="tabs-container public-view">
    <div class="tabs"><button class="tab active" onclick="switchTab('warga')">üìù Data Warga</button> <button class="tab" onclick="switchTab('kegiatan')">üéâ Kegiatan</button> <button class="tab" onclick="switchTab('kas')">üí∞ Laporan Kas</button> <button class="tab" onclick="switchTab('iuran')">üìä Rekapitulasi Iuran</button> <button class="tab" onclick="switchTab('aset')">üè† Data Aset</button>
    </div><!-- TAB 1: DATA WARGA -->
    <div id="tab-warga" class="tab-content active">
     <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
      <div class="tab-add-buttons" id="warga-buttons"><button class="btn-add" onclick="openFormModal('warga')"> ‚ûï Tambah Data Warga </button>
      </div>
      <div class="iuran-summary-boxes">
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="iuran-summary-label">
         üë• Total Jiwa
        </div>
        <div class="iuran-summary-value" id="total-jiwa">
         0
        </div>
       </div>
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="iuran-summary-label">
         üè† Total KK
        </div>
        <div class="iuran-summary-value" id="total-kk">
         0
        </div>
       </div>
      </div>
     </div>
     <div id="history-warga"></div>
    </div><!-- TAB 2: KEGIATAN WARGA -->
    <div id="tab-kegiatan" class="tab-content">
     <div class="tab-add-buttons" id="kegiatan-buttons"><button class="btn-add" onclick="openFormModal('kegiatan')"> ‚ûï Tambah Kegiatan </button>
     </div>
     <div id="history-kegiatan"></div>
    </div><!-- TAB 3: LAPORAN KAS -->
    <div id="tab-kas" class="tab-content">
     <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
      <div class="tab-add-buttons" id="kas-buttons"><button class="btn-add" onclick="openFormModal('kas')"> ‚ûï Tambah Transaksi Kas </button>
      </div>
      <div class="iuran-summary-boxes">
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
        <div class="iuran-summary-label">
         üíú Saldo Dana Sosial
        </div>
        <div class="iuran-summary-value" id="saldo-sosial">
         Rp 0
        </div>
       </div>
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
        <div class="iuran-summary-label">
         üíµ Saldo Dana Kas
        </div>
        <div class="iuran-summary-value" id="saldo-kas">
         Rp 0
        </div>
       </div>
      </div>
     </div>
     <div id="history-kas"></div>
    </div><!-- TAB 4: REKAPITULASI IURAN -->
    <div id="tab-iuran" class="tab-content">
     <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
      <div class="tab-add-buttons" id="iuran-buttons"><button class="btn-add" onclick="openFormModal('iuran')"> ‚ûï Bayar Iuran Warga </button>
      </div>
      <div class="iuran-summary-boxes">
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);">
        <div class="iuran-summary-label">
         üíµ Total Iuran Kas
        </div>
        <div class="iuran-summary-value" id="total-iuran-kas">
         Rp 0
        </div>
       </div>
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);">
        <div class="iuran-summary-label">
         üí∞ Total Iuran Sosial
        </div>
        <div class="iuran-summary-value" id="total-iuran-sosial">
         Rp 0
        </div>
       </div>
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
        <div class="iuran-summary-label">
         üìä Total Iuran
        </div>
        <div class="iuran-summary-value" id="total-iuran">
         Rp 0
        </div>
       </div>
      </div>
     </div>
     <div id="history-iuran"></div>
    </div><!-- TAB 5: DATA ASET -->
    <div id="tab-aset" class="tab-content">
     <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
      <div class="tab-add-buttons" id="aset-buttons"><button class="btn-add" onclick="openFormModal('aset')"> ‚ûï Tambah Data Aset </button>
      </div>
      <div class="iuran-summary-boxes">
       <div class="iuran-summary-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="iuran-summary-label">
         üè† Total Nilai Aset
        </div>
        <div class="iuran-summary-value" id="total-nilai-aset">
         Rp 0
        </div>
       </div>
      </div>
     </div>
     <div id="history-aset"></div>
    </div>
   </main>
   <footer class="footer">
    <div id="footerText">
     ¬© 2025 - 2030 Input Data Admin
    </div>
   </footer>
  </div>
  <script>
    // URL WEB APP APPS SCRIPT
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxBl-pXpELFj0tPF4JDQ4zWRbXLAsI-DyNi0CZPhOAAUHJi8MRXPnMMNw2xGA6sB1iK/exec';
    const LOGIN_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRayzlXZjRJBh1eAvGyeHhFeDZsLm8Q9Qzs1PriF2MRngkHDscyB_cqPEoQRvyap09SOMdbIQAPwofh/pub?gid=1061051791&single=true&output=csv';

    // Config default
    const defaultConfig = {
      app_title: 'INPUT DATA ADMIN',
      footer_text: '¬© 2025 - 2030 Input Data Admin',
      primary_color: '#3b82f6',
      secondary_color: '#60a5fa'
    };

    // State management
    let currentTab = 'warga';
    let wargaList = [];
    let existingNoKKList = [];
    let currentSelectedWarga = null;
    let bulanCheckboxes = [];
    let isAdminLoggedIn = false;
    let currentAdmin = null;
    let currentModalType = null;
    
    // Cache untuk setiap tab (agar tidak reload terus)
    let dataCache = {
      warga: null,
      kegiatan: null,
      kas: null,
      iuran: null,
      aset: null,
      saldo: null
    };

    // Bulan list untuk checkbox
    const bulanNames = [
      'Okt 2025', 'Nov 2025', 'Des 2025',
      'Jan 2026', 'Feb 2026', 'Mar 2026', 'Apr 2026', 'Mei 2026', 'Jun 2026',
      'Jul 2026', 'Agu 2026', 'Sep 2026', 'Okt 2026', 'Nov 2026', 'Des 2026',
      'Jan 2027', 'Feb 2027', 'Mar 2027', 'Apr 2027', 'Mei 2027', 'Jun 2027',
      'Jul 2027', 'Agu 2027', 'Sep 2027', 'Okt 2027', 'Nov 2027', 'Des 2027',
      'Jan 2028', 'Feb 2028', 'Mar 2028', 'Apr 2028', 'Mei 2028', 'Jun 2028',
      'Jul 2028', 'Agu 2028', 'Sep 2028', 'Okt 2028', 'Nov 2028', 'Des 2028',
      'Jan 2029', 'Feb 2029', 'Mar 2029', 'Apr 2029', 'Mei 2029', 'Jun 2029',
      'Jul 2029', 'Agu 2029', 'Sep 2029', 'Okt 2029', 'Nov 2029', 'Des 2029',
      'Jan 2030', 'Feb 2030', 'Mar 2030', 'Apr 2030', 'Mei 2030', 'Jun 2030',
      'Jul 2030', 'Agu 2030', 'Sep 2030'
    ];

    // ========== LOGIN FUNCTIONS ==========
    
    function showLoginModal() {
      document.getElementById('loginModal').classList.add('show');
      document.getElementById('adminUsername').focus();
    }

    function hideLoginModal() {
      document.getElementById('loginModal').classList.remove('show');
      document.getElementById('loginForm').reset();
      document.getElementById('loginError').style.display = 'none';
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      const btnLogin = document.getElementById('btnLogin');
      const loginError = document.getElementById('loginError');

      btnLogin.disabled = true;
      btnLogin.textContent = 'Memvalidasi...';
      loginError.style.display = 'none';

      try {
        const response = await fetch(LOGIN_CSV_URL);
        const csvText = await response.text();
        const lines = csvText.split('\n');

        let isValid = false;
        let adminName = '';

        // Mulai dari baris ke-4 (index 3), kolom B dan C
        for (let i = 3; i < lines.length; i++) {
          const cols = lines[i].split(',');
          if (cols.length >= 3) {
            const csvUsername = cols[1].trim(); // Kolom B
            const csvPassword = cols[2].trim(); // Kolom C
            
            if (csvUsername === username && csvPassword === password) {
              isValid = true;
              adminName = csvUsername;
              break;
            }
          }
        }

        if (isValid) {
          isAdminLoggedIn = true;
          currentAdmin = adminName;
          
          // Update UI
          document.getElementById('adminName').textContent = adminName;
          document.getElementById('adminAvatar').textContent = adminName.charAt(0).toUpperCase();
          document.getElementById('adminPanel').classList.add('show');
          document.getElementById('btnLoginHeader').style.display = 'none';
          
          // Update judul
          document.getElementById('appTitle').textContent = 'INPUT DATA ADMIN';
          
          // Show tombol di semua tab
          document.getElementById('warga-buttons').classList.add('show');
          document.getElementById('kegiatan-buttons').classList.add('show');
          document.getElementById('kas-buttons').classList.add('show');
          document.getElementById('iuran-buttons').classList.add('show');
          document.getElementById('aset-buttons').classList.add('show');
          
          hideLoginModal();
        } else {
          loginError.textContent = '‚ùå Username atau password salah!';
          loginError.style.display = 'block';
        }
      } catch (error) {
        loginError.textContent = '‚ùå Error: ' + error.message;
        loginError.style.display = 'block';
      }

      btnLogin.disabled = false;
      btnLogin.textContent = 'Masuk';
    }

    function handleLogout() {
      isAdminLoggedIn = false;
      currentAdmin = null;
      
      document.getElementById('adminPanel').classList.remove('show');
      document.getElementById('btnLoginHeader').style.display = 'flex';
      
      // Kembalikan judul
      document.getElementById('appTitle').textContent = 'INPUT DATA ADMIN';
      
      // Hide tombol di semua tab
      document.getElementById('warga-buttons').classList.remove('show');
      document.getElementById('kegiatan-buttons').classList.remove('show');
      document.getElementById('kas-buttons').classList.remove('show');
      document.getElementById('iuran-buttons').classList.remove('show');
      document.getElementById('aset-buttons').classList.remove('show');
      
      closeModal();
    }

    // ========== MODAL FUNCTIONS ==========

    function openFormModal(type) {
      if (!isAdminLoggedIn) {
        showLoginModal();
        return;
      }

      currentModalType = type;
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      let title = '';
      let formHTML = '';

      if (type === 'warga') {
        title = '‚ûï Tambah Data Warga';
        formHTML = `
          <div id="modal-success" class="success-message"></div>
          <div id="modal-error" class="error-message"></div>
          <form id="modal-form" onsubmit="submitModalWarga(event)">
            <div class="form-group">
              <label for="m_noKK">No KK</label>
              <input type="text" id="m_noKK" required onblur="checkNoKKDuplicate()">
              <div id="nokk-warning" style="display: none; color: #f56565; font-size: 13px; margin-top: 4px;">‚ö†Ô∏è No KK sudah terdaftar!</div>
            </div>
            <div class="form-group">
              <label for="m_nama">Nama Lengkap</label>
              <input type="text" id="m_nama" required>
            </div>
            <div class="form-group">
              <label for="m_alamat">Alamat</label>
              <textarea id="m_alamat" required></textarea>
            </div>
            <div class="form-group">
              <label for="m_jumlahJiwa">Jumlah Jiwa</label>
              <input type="number" id="m_jumlahJiwa" required min="1">
            </div>
            <button type="submit" class="btn btn-primary" id="modal-btn">Simpan</button>
          </form>
        `;
        // Load existing No KK untuk validasi
        setTimeout(() => {
          loadExistingNoKK();
        }, 100);
      } else if (type === 'kegiatan') {
        title = '‚ûï Tambah Kegiatan';
        formHTML = `
          <div id="modal-success" class="success-message"></div>
          <div id="modal-error" class="error-message"></div>
          <form id="modal-form" onsubmit="submitModalKegiatan(event)">
            <div class="form-group">
              <label for="m_tanggalKegiatan">Tanggal Kegiatan</label>
              <input type="date" id="m_tanggalKegiatan" required>
            </div>
            <div class="form-group">
              <label for="m_judulKegiatan">Judul Kegiatan</label>
              <input type="text" id="m_judulKegiatan" required>
            </div>
            <div class="form-group">
              <label for="m_deskripsiKegiatan">Deskripsi</label>
              <textarea id="m_deskripsiKegiatan" required></textarea>
            </div>
            <div class="form-group">
              <label for="m_kategoriKegiatan">Kategori</label>
              <select id="m_kategoriKegiatan" required>
                <option value="">Pilih Kategori</option>
                <option value="Sosial">Sosial</option>
                <option value="Kebersihan">Kebersihan</option>
                <option value="Keamanan">Keamanan</option>
                <option value="Olahraga">Olahraga</option>
                <option value="Keagamaan">Keagamaan</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            <div class="form-group">
              <label for="m_urlFoto">URL Foto (Opsional)</label>
              <input type="url" id="m_urlFoto">
            </div>
            <div class="form-group">
              <label for="m_urlAlbum">URL Album (Opsional)</label>
              <input type="url" id="m_urlAlbum">
            </div>
            <button type="submit" class="btn btn-primary" id="modal-btn">Simpan</button>
          </form>
        `;
      } else if (type === 'kas') {
        title = '‚ûï Tambah Transaksi Kas';
        formHTML = `
          <div id="modal-success" class="success-message"></div>
          <div id="modal-error" class="error-message"></div>
          <form id="modal-form" onsubmit="submitModalKas(event)">
            <div class="form-group">
              <label for="m_tanggalKas">Tanggal Transaksi</label>
              <input type="date" id="m_tanggalKas" required>
            </div>
            <div class="form-group">
              <label for="m_keteranganKas">Keterangan</label>
              <input type="text" id="m_keteranganKas" required>
            </div>
            <div class="form-group">
              <label for="m_jenisTransaksi">Jenis Transaksi</label>
              <select id="m_jenisTransaksi" required onchange="handleModalJenisTransaksi()">
                <option value="">Pilih Jenis</option>
                <option value="PEMASUKAN">Pemasukan</option>
                <option value="SOSIAL">Pengeluaran Sosial</option>
                <option value="KAS">Pengeluaran Kas</option>
              </select>
            </div>
            <div id="m_pemasukan-fields" style="display: none;">
              <div class="form-group">
                <label for="m_danaSosial">Dana Sosial</label>
                <input type="number" id="m_danaSosial" min="0" value="0">
              </div>
              <div class="form-group">
                <label for="m_danaKas">Dana Kas</label>
                <input type="number" id="m_danaKas" min="0" value="0">
              </div>
            </div>
            <div id="m_pengeluaran-field" style="display: none;">
              <div class="form-group">
                <label for="m_jumlahPengeluaran">Jumlah Pengeluaran</label>
                <input type="number" id="m_jumlahPengeluaran" min="0" value="0">
              </div>
            </div>
            <button type="submit" class="btn btn-primary" id="modal-btn">Simpan</button>
          </form>
        `;
      } else if (type === 'iuran') {
        title = '‚ûï Bayar Iuran Warga';
        formHTML = `
          <div id="modal-success" class="success-message"></div>
          <div id="modal-error" class="error-message"></div>
          <div class="form-group">
            <label for="m_filterWarga">Cari Warga</label>
            <input type="text" id="m_filterWarga" placeholder="Ketik nama atau No KK..." oninput="modalFilterWargaList()">
            <div id="m_warga-dropdown" class="warga-dropdown"></div>
          </div>
          <div id="m_iuran-form-container" style="display: none;">
            <form id="modal-form" onsubmit="submitModalIuran(event)">
              <input type="hidden" id="m_iuranNoKK">
              <input type="hidden" id="m_iuranNama">
              <input type="hidden" id="m_iuranAlamat">
              <div class="form-group">
                <label>Pilih Bulan yang Dibayar (Rp 15.000/bulan)</label>
                <div class="checkbox-grid" id="m_checkbox-bulan"></div>
              </div>
              <div id="payment-summary-container" style="display: none;" class="payment-summary">
                <div class="payment-summary-title">üí∞ Ringkasan Pembayaran</div>
                <div class="payment-calculation" id="payment-calc">0 x Rp 15.000 = Rp 0</div>
                <div class="payment-months">
                  <strong>Bulan yang dibayar:</strong><br>
                  <span id="payment-months-list">-</span>
                </div>
              </div>
              <div class="button-group">
                <button type="submit" class="btn btn-primary" id="modal-btn">Bayar</button>
                <button type="button" class="btn-cancel" onclick="closeModal()">Batal</button>
              </div>
            </form>
          </div>
        `;
        // Load warga list untuk iuran
        setTimeout(() => {
          loadModalWargaList();
        }, 100);
      } else if (type === 'aset') {
        title = '‚ûï Tambah Data Aset';
        formHTML = `
          <div id="modal-success" class="success-message"></div>
          <div id="modal-error" class="error-message"></div>
          <form id="modal-form" onsubmit="submitModalAset(event)">
            <div class="form-group">
              <label for="m_namaAset">Nama Aset</label>
              <input type="text" id="m_namaAset" required>
            </div>
            <div class="form-group">
              <label for="m_jumlahAset">Jumlah</label>
              <input type="number" id="m_jumlahAset" required min="1">
            </div>
            <div class="form-group">
              <label for="m_jenisAset">Jenis Aset</label>
              <select id="m_jenisAset" required>
                <option value="">Pilih Jenis</option>
                <option value="Elektronik">Elektronik</option>
                <option value="Furniture">Furniture</option>
                <option value="Kendaraan">Kendaraan</option>
                <option value="Alat Kebersihan">Alat Kebersihan</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            <div class="form-group">
              <label for="m_kondisiAset">Kondisi</label>
              <select id="m_kondisiAset" required>
                <option value="">Pilih Kondisi</option>
                <option value="Baik">Baik</option>
                <option value="Rusak Ringan">Rusak Ringan</option>
                <option value="Rusak Berat">Rusak Berat</option>
              </select>
            </div>
            <div class="form-group">
              <label for="m_lokasiAset">Lokasi</label>
              <input type="text" id="m_lokasiAset" required>
            </div>
            <div class="form-group">
              <label for="m_tahunBeli">Tahun Pembelian</label>
              <input type="number" id="m_tahunBeli" required min="1900" max="2100">
            </div>
            <div class="form-group">
              <label for="m_hargaTotal">Harga Total</label>
              <input type="number" id="m_hargaTotal" required min="0">
            </div>
            <div class="form-group">
              <label for="m_keteranganAset">Keterangan (Opsional)</label>
              <textarea id="m_keteranganAset"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="modal-btn">Simpan</button>
          </form>
        `;
      }

      modalTitle.textContent = title;
      modalBody.innerHTML = formHTML;
      document.getElementById('modalOverlay').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
      currentModalType = null;
      currentSelectedWarga = null;
    }

    // Initialize Element SDK
    async function onConfigChange(config) {
      document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('footerText').textContent = config.footer_text || defaultConfig.footer_text;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['footer_text', config.footer_text || defaultConfig.footer_text]
        ])
      });
    }

    // Tab switching
    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');

      // Load data HANYA jika belum pernah di-load (cache kosong)
      if (tabName === 'warga' && !dataCache.warga) {
        loadHistory('WARGA');
        calculateWargaSummary();
      } else if (tabName === 'kegiatan' && !dataCache.kegiatan) {
        loadHistory('KEGIATAN');
      } else if (tabName === 'kas' && !dataCache.kas) {
        loadSaldo();
        loadHistory('KAS');
      } else if (tabName === 'iuran' && !dataCache.iuran) {
        loadWargaList();
        loadHistory('IURAN');
        calculateIuranSummary();
      } else if (tabName === 'aset' && !dataCache.aset) {
        loadHistory('ASET');
        calculateAsetSummary();
      }
    }

    // Show message helper
    function showMessage(type, tabName, message) {
      const el = document.getElementById(tabName + '-' + type);
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => {
        el.style.display = 'none';
      }, 4000);
    }

    // Format rupiah
    function formatRupiah(number) {
      return 'Rp ' + number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // ========== VALIDASI NO KK ==========
    
    async function loadExistingNoKK() {
      try {
        const response = await fetch(WEB_APP_URL + '?action=getHistory&tabType=WARGA');
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // Ambil semua No KK dan convert ke string untuk perbandingan yang lebih akurat
          existingNoKKList = result.data
            .map(warga => String(warga.noKK || '').trim())
            .filter(nokk => nokk !== '');
          
          console.log('Existing No KK List:', existingNoKKList);
        }
      } catch (error) {
        console.error('Error loading No KK:', error);
      }
    }

    function checkNoKKDuplicate() {
      const noKK = String(document.getElementById('m_noKK').value || '').trim();
      const warning = document.getElementById('nokk-warning');
      const submitBtn = document.getElementById('modal-btn');
      
      console.log('Checking No KK:', noKK);
      console.log('Against list:', existingNoKKList);
      
      if (noKK && existingNoKKList.includes(noKK)) {
        warning.style.display = 'block';
        submitBtn.disabled = true;
        return false;
      } else {
        warning.style.display = 'none';
        submitBtn.disabled = false;
        return true;
      }
    }

    // ========== MODAL SUBMIT FUNCTIONS ==========

    function showModalMessage(type, message) {
      const el = document.getElementById('modal-' + type);
      if (el) {
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => {
          el.style.display = 'none';
        }, 3000);
      }
    }

    async function submitModalWarga(e) {
      e.preventDefault();
      
      // Validasi No KK sebelum submit
      if (!checkNoKKDuplicate()) {
        showModalMessage('error', '‚ùå No KK sudah terdaftar!');
        return;
      }
      
      const btn = document.getElementById('modal-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const data = {
        tabType: 'DATA_WARGA',
        noKK: document.getElementById('m_noKK').value,
        nama: document.getElementById('m_nama').value,
        alamat: document.getElementById('m_alamat').value,
        jumlahJiwa: document.getElementById('m_jumlahJiwa').value
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.text();
        
        if (result === 'SUCCESS') {
          showModalMessage('success', '‚úÖ Data berhasil disimpan!');
          setTimeout(() => {
            closeModal();
            dataCache.warga = null;
            loadHistory('WARGA');
            calculateWargaSummary();
          }, 1500);
        } else {
          showModalMessage('error', '‚ùå Gagal: ' + result);
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }
      } catch (error) {
        showModalMessage('error', '‚ùå Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Simpan';
      }
    }

    async function submitModalKegiatan(e) {
      e.preventDefault();
      const btn = document.getElementById('modal-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const data = {
        tabType: 'KEGIATAN_WARGA',
        tanggal: document.getElementById('m_tanggalKegiatan').value,
        judul: document.getElementById('m_judulKegiatan').value,
        deskripsi: document.getElementById('m_deskripsiKegiatan').value,
        kategori: document.getElementById('m_kategoriKegiatan').value,
        urlFoto: document.getElementById('m_urlFoto').value,
        urlAlbum: document.getElementById('m_urlAlbum').value
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.text();
        
        if (result === 'SUCCESS') {
          showModalMessage('success', '‚úÖ Data berhasil disimpan!');
          setTimeout(() => {
            closeModal();
            dataCache.kegiatan = null;
            loadHistory('KEGIATAN');
          }, 1500);
        } else {
          showModalMessage('error', '‚ùå Gagal: ' + result);
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }
      } catch (error) {
        showModalMessage('error', '‚ùå Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Simpan';
      }
    }

    function handleModalJenisTransaksi() {
      const jenis = document.getElementById('m_jenisTransaksi').value;
      const pemasukanFields = document.getElementById('m_pemasukan-fields');
      const pengeluaranField = document.getElementById('m_pengeluaran-field');

      if (jenis === 'PEMASUKAN') {
        pemasukanFields.style.display = 'block';
        pengeluaranField.style.display = 'none';
      } else if (jenis === 'SOSIAL' || jenis === 'KAS') {
        pemasukanFields.style.display = 'none';
        pengeluaranField.style.display = 'block';
      } else {
        pemasukanFields.style.display = 'none';
        pengeluaranField.style.display = 'none';
      }
    }

    async function submitModalKas(e) {
      e.preventDefault();
      const btn = document.getElementById('modal-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const data = {
        tabType: 'LAPORAN_KAS',
        tanggal: document.getElementById('m_tanggalKas').value,
        keterangan: document.getElementById('m_keteranganKas').value,
        jenisTransaksi: document.getElementById('m_jenisTransaksi').value,
        danaSosial: document.getElementById('m_danaSosial').value || '0',
        danaKas: document.getElementById('m_danaKas').value || '0',
        jumlahPengeluaran: document.getElementById('m_jumlahPengeluaran').value || '0'
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.text();
        
        if (result === 'SUCCESS') {
          showModalMessage('success', '‚úÖ Data berhasil disimpan!');
          setTimeout(() => {
            closeModal();
            dataCache.kas = null;
            dataCache.saldo = null;
            loadSaldo();
            loadHistory('KAS');
          }, 1500);
        } else {
          showModalMessage('error', '‚ùå Gagal: ' + result);
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }
      } catch (error) {
        showModalMessage('error', '‚ùå Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Simpan';
      }
    }

    async function loadModalWargaList() {
      if (wargaList.length === 0) {
        await loadWargaList();
      }
    }

    function modalFilterWargaList() {
      const filterValue = document.getElementById('m_filterWarga').value.toLowerCase();
      const dropdown = document.getElementById('m_warga-dropdown');
      
      if (filterValue.length < 2) {
        dropdown.classList.remove('show');
        return;
      }

      const filtered = wargaList.filter(warga => {
        const namaStr = String(warga.nama || '').toLowerCase();
        const noKKStr = String(warga.noKK || '').toLowerCase();
        const alamatStr = String(warga.alamat || '').toLowerCase();
        return namaStr.includes(filterValue) || noKKStr.includes(filterValue) || alamatStr.includes(filterValue);
      });

      if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="warga-item"><div class="warga-item-name">Tidak ada hasil</div></div>';
        dropdown.classList.add('show');
        return;
      }

      dropdown.innerHTML = '';
      filtered.forEach((warga) => {
        const item = document.createElement('div');
        item.className = 'warga-item';
        item.onclick = () => modalSelectWarga(warga);
        
        item.innerHTML = `
          <div class="warga-item-name">${warga.nama}</div>
          <div class="warga-item-detail">No KK: ${warga.noKK}</div>
          <div class="warga-item-detail">Alamat: ${warga.alamat}</div>
        `;
        
        dropdown.appendChild(item);
      });

      dropdown.classList.add('show');
    }

    function modalSelectWarga(warga) {
      currentSelectedWarga = warga;
      document.getElementById('m_filterWarga').value = `${warga.nama} (${warga.noKK})`;
      document.getElementById('m_warga-dropdown').classList.remove('show');
      loadModalPembayaran();
    }

    async function loadModalPembayaran() {
      if (!currentSelectedWarga) return;
      
      document.getElementById('m_iuranNoKK').value = currentSelectedWarga.noKK;
      document.getElementById('m_iuranNama').value = currentSelectedWarga.nama;
      document.getElementById('m_iuranAlamat').value = currentSelectedWarga.alamat;

      const checkboxContainer = document.getElementById('m_checkbox-bulan');
      checkboxContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

      try {
        const response = await fetch(WEB_APP_URL + '?action=getPembayaran&nama=' + encodeURIComponent(currentSelectedWarga.nama));
        const result = await response.json();
        
        if (result.success) {
          const checkedBulan = result.data || [];
          checkboxContainer.innerHTML = '';

          bulanNames.forEach((bulan, index) => {
            const colIndex = index + 5;
            const isChecked = checkedBulan.includes(colIndex);
            
            let yearClass = '';
            if (bulan.includes('2025')) yearClass = 'year-2025';
            else if (bulan.includes('2026')) yearClass = 'year-2026';
            else if (bulan.includes('2027')) yearClass = 'year-2027';
            else if (bulan.includes('2028')) yearClass = 'year-2028';
            else if (bulan.includes('2029')) yearClass = 'year-2029';
            else if (bulan.includes('2030')) yearClass = 'year-2030';
            
            const checkboxItem = document.createElement('div');
            checkboxItem.className = `checkbox-item ${yearClass}${isChecked ? ' paid' : ''}`;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'm_bulan-' + colIndex;
            checkbox.value = colIndex;
            checkbox.checked = isChecked;
            checkbox.disabled = isChecked;
            checkbox.onchange = function() {
              updatePaymentSummary();
              toggleCheckboxClass(checkboxItem, checkbox);
            };
            
            const label = document.createElement('label');
            label.htmlFor = 'm_bulan-' + colIndex;
            label.textContent = bulan + (isChecked ? ' ‚úì' : '');
            
            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            
            // Buat seluruh area bisa diklik untuk toggle checkbox (kecuali yang sudah paid)
            if (!isChecked) {
              checkboxItem.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                checkbox.checked = !checkbox.checked;
                updatePaymentSummary();
                toggleCheckboxClass(checkboxItem, checkbox);
              };
              
              // Prevent default behavior on checkbox to let parent handle it
              checkbox.onclick = function(e) {
                e.stopPropagation();
              };
              
              label.onclick = function(e) {
                e.stopPropagation();
              };
            }
            
            checkboxContainer.appendChild(checkboxItem);
          });

          document.getElementById('m_iuran-form-container').style.display = 'block';
        }
      } catch (error) {
        checkboxContainer.innerHTML = '<div class="loading">Error: ' + error.message + '</div>';
      }
    }

    function toggleCheckboxClass(checkboxItem, checkbox) {
      if (checkbox.checked && !checkbox.disabled) {
        checkboxItem.classList.add('checked');
      } else {
        checkboxItem.classList.remove('checked');
      }
    }

    function updatePaymentSummary() {
      const checkedBulan = [];
      const checkedBulanNames = [];
      
      document.querySelectorAll('#m_checkbox-bulan input[type="checkbox"]:checked:not(:disabled)').forEach(cb => {
        const colIndex = parseInt(cb.value);
        checkedBulan.push(colIndex);
        
        // Ambil nama bulan dari bulanNames array
        const bulanIndex = colIndex - 5;
        if (bulanIndex >= 0 && bulanIndex < bulanNames.length) {
          checkedBulanNames.push(bulanNames[bulanIndex]);
        }
      });
      
      const summaryContainer = document.getElementById('payment-summary-container');
      const calcElement = document.getElementById('payment-calc');
      const monthsListElement = document.getElementById('payment-months-list');
      
      if (checkedBulan.length > 0) {
        summaryContainer.style.display = 'block';
        const total = checkedBulan.length * 15000;
        calcElement.textContent = `${checkedBulan.length} x Rp 15.000 = Rp ${total.toLocaleString('id-ID')}`;
        monthsListElement.textContent = checkedBulanNames.join(', ');
      } else {
        summaryContainer.style.display = 'none';
      }
    }

    async function submitModalIuran(e) {
      e.preventDefault();
      const btn = document.getElementById('modal-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const checkedBulan = [];
      document.querySelectorAll('#m_checkbox-bulan input[type="checkbox"]:checked:not(:disabled)').forEach(cb => {
        checkedBulan.push(parseInt(cb.value));
      });

      if (checkedBulan.length === 0) {
        showModalMessage('error', '‚ùå Pilih minimal 1 bulan!');
        btn.disabled = false;
        btn.textContent = 'Bayar';
        return;
      }

      const data = {
        tabType: 'REKAPITULASI_IURAN',
        namaWarga: document.getElementById('m_iuranNama').value,
        noKK: document.getElementById('m_iuranNoKK').value,
        alamat: document.getElementById('m_iuranAlamat').value,
        bulanDibayar: checkedBulan
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.text();
        
        if (result === 'SUCCESS') {
          showModalMessage('success', '‚úÖ Pembayaran berhasil!');
          setTimeout(() => {
            closeModal();
            dataCache.iuran = null;
            loadHistory('IURAN');
            calculateIuranSummary();
          }, 1500);
        } else {
          showModalMessage('error', '‚ùå Gagal: ' + result);
          btn.disabled = false;
          btn.textContent = 'Bayar';
        }
      } catch (error) {
        showModalMessage('error', '‚ùå Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Bayar';
      }
    }

    async function submitModalAset(e) {
      e.preventDefault();
      const btn = document.getElementById('modal-btn');
      btn.disabled = true;
      btn.textContent = 'Menyimpan...';

      const data = {
        tabType: 'DATA_ASET',
        namaAset: document.getElementById('m_namaAset').value,
        jumlah: document.getElementById('m_jumlahAset').value,
        jenisAset: document.getElementById('m_jenisAset').value,
        kondisi: document.getElementById('m_kondisiAset').value,
        lokasi: document.getElementById('m_lokasiAset').value,
        tahunBeli: document.getElementById('m_tahunBeli').value,
        hargaTotal: document.getElementById('m_hargaTotal').value,
        keterangan: document.getElementById('m_keteranganAset').value
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        
        const result = await response.text();
        
        if (result === 'SUCCESS') {
          showModalMessage('success', '‚úÖ Data berhasil disimpan!');
          setTimeout(() => {
            closeModal();
            dataCache.aset = null;
            loadHistory('ASET');
            calculateAsetSummary();
          }, 1500);
        } else {
          showModalMessage('error', '‚ùå Gagal: ' + result);
          btn.disabled = false;
          btn.textContent = 'Simpan';
        }
      } catch (error) {
        showModalMessage('error', '‚ùå Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Simpan';
      }
    }

    // ========== LOAD FUNCTIONS ==========

    async function loadSaldo() {
      try {
        const response = await fetch(WEB_APP_URL + '?action=getSaldo');
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('saldo-sosial').textContent = formatRupiah(result.saldoDanaSosial);
          document.getElementById('saldo-kas').textContent = formatRupiah(result.saldoDanaKas);
          dataCache.saldo = true;
        }
      } catch (error) {
        console.error('Error loading saldo:', error);
      }
    }

    async function calculateIuranSummary() {
      try {
        // Fetch dari endpoint khusus untuk hitung total dari kolom E-BL
        const response = await fetch(WEB_APP_URL + '?action=getTotalIuran');
        const result = await response.json();
        
        if (result.success) {
          const totalIuran = result.totalIuran || 0;
          
          // Total Iuran Sosial = (Total / 3) * 2
          const totalIuranSosial = Math.round((totalIuran / 3) * 2);
          
          // Total Iuran Kas = Total / 3
          const totalIuranKas = Math.round(totalIuran / 3);
          
          // Update UI
          document.getElementById('total-iuran-sosial').textContent = formatRupiah(totalIuranSosial);
          document.getElementById('total-iuran-kas').textContent = formatRupiah(totalIuranKas);
          document.getElementById('total-iuran').textContent = formatRupiah(totalIuran);
        } else {
          document.getElementById('total-iuran-sosial').textContent = 'Rp 0';
          document.getElementById('total-iuran-kas').textContent = 'Rp 0';
          document.getElementById('total-iuran').textContent = 'Rp 0';
        }
      } catch (error) {
        console.error('Error calculating iuran summary:', error);
        document.getElementById('total-iuran-sosial').textContent = 'Rp 0';
        document.getElementById('total-iuran-kas').textContent = 'Rp 0';
        document.getElementById('total-iuran').textContent = 'Rp 0';
      }
    }

    async function calculateWargaSummary() {
      try {
        // Fetch data untuk hitung total jiwa dan KK dari sheet REKAP IURAN
        const response = await fetch(WEB_APP_URL + '?action=getWargaSummary');
        const result = await response.json();
        
        if (result.success) {
          // Update UI
          document.getElementById('total-jiwa').textContent = result.totalJiwa || 0;
          document.getElementById('total-kk').textContent = result.totalKK || 0;
        } else {
          document.getElementById('total-jiwa').textContent = '0';
          document.getElementById('total-kk').textContent = '0';
        }
      } catch (error) {
        console.error('Error calculating warga summary:', error);
        document.getElementById('total-jiwa').textContent = '0';
        document.getElementById('total-kk').textContent = '0';
      }
    }

    async function calculateAsetSummary() {
      try {
        // Hitung dari data history langsung
        const response = await fetch(WEB_APP_URL + '?action=getHistory&tabType=ASET');
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          let totalNilai = 0;
          result.data.forEach(aset => {
            const harga = parseInt(aset.hargaTotal) || 0;
            totalNilai += harga;
          });
          document.getElementById('total-nilai-aset').textContent = formatRupiah(totalNilai);
        } else {
          document.getElementById('total-nilai-aset').textContent = 'Rp 0';
        }
      } catch (error) {
        console.error('Error calculating aset summary:', error);
        document.getElementById('total-nilai-aset').textContent = 'Rp 0';
      }
    }

    async function loadHistory(tabType) {
      const historyContainer = document.getElementById('history-' + tabType.toLowerCase());
      historyContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading data...</div>';

      try {
        const response = await fetch(WEB_APP_URL + '?action=getHistory&tabType=' + tabType);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          let tableHTML = '<table class="history-table"><thead><tr>';
          
          // Header berdasarkan tipe
          if (tabType === 'WARGA') {
            tableHTML += '<th>Timestamp</th><th>No KK</th><th>Nama</th><th>Alamat</th><th>Jumlah Jiwa</th>';
          } else if (tabType === 'KEGIATAN') {
            tableHTML += '<th>Timestamp</th><th>Tanggal</th><th>Judul</th><th>Deskripsi</th><th>Kategori</th>';
          } else if (tabType === 'KAS') {
            tableHTML += '<th>Timestamp</th><th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Pemasukan Sosial</th><th>Pemasukan Kas</th><th>Pengeluaran</th>';
          } else if (tabType === 'IURAN') {
            tableHTML += '<th>Timestamp</th><th>No KK</th><th>Nama</th><th>Alamat</th><th>Bulan Dibayar</th><th>Jumlah Bulan</th><th>Total</th>';
          } else if (tabType === 'ASET') {
            tableHTML += '<th>Timestamp</th><th>Nama Aset</th><th>Jumlah</th><th>Jenis</th><th>Kondisi</th><th>Lokasi</th><th>Tahun</th><th>Harga</th>';
          }
          
          tableHTML += '</tr></thead><tbody>';

          // Reverse data untuk tampil terbaru di atas
          result.data.reverse().forEach(item => {
            tableHTML += '<tr>';
            
            if (tabType === 'WARGA') {
              tableHTML += `<td>${item.timestamp}</td><td>${item.noKK}</td><td>${item.nama}</td><td>${item.alamat}</td><td>${item.jumlahJiwa}</td>`;
            } else if (tabType === 'KEGIATAN') {
              tableHTML += `<td>${item.timestamp}</td><td>${item.tanggal}</td><td>${item.judul}</td><td>${item.deskripsi}</td><td>${item.kategori}</td>`;
            } else if (tabType === 'KAS') {
              // Helper function untuk parse number
              const parseNumber = (val) => {
                if (val === null || val === undefined) return null;
                const strVal = String(val).trim();
                if (strVal === '' || strVal === '-') return null;
                if (typeof val === 'number') return isNaN(val) ? null : val;
                const cleaned = strVal.replace(/\D/g, '');
                if (cleaned === '') return null;
                const num = parseInt(cleaned, 10);
                return isNaN(num) ? null : num;
              };
              
              // Parse pemasukan
              const danaSosialNum = parseNumber(item.danaSosial || item.sosialMasuk);
              const danaKasNum = parseNumber(item.danaKas || item.kasMasuk);
              
              // Parse pengeluaran dengan FALLBACK SUPER AGRESIF
              let pengeluaranNum = null;
              if (item.jenisTransaksi === 'SOSIAL') {
                // Coba SEMUA kemungkinan field untuk SOSIAL KELUAR
                pengeluaranNum = parseNumber(
                  item.sosialKeluar || 
                  item['SOSIAL KELUAR'] ||
                  item.SOSIALKELUAR ||
                  item['Sosial Keluar'] ||
                  item.jumlahPengeluaran || 
                  item.pengeluaran ||
                  item.keluar ||
                  item['KELUAR']
                );
                
                // DEBUG: Log kalau masih null untuk SOSIAL
                if (pengeluaranNum === null) {
                  console.log('‚ö†Ô∏è SOSIAL KELUAR NULL - Item:', item);
                  console.log('Available keys:', Object.keys(item));
                }
              } else if (item.jenisTransaksi === 'KAS') {
                // Coba SEMUA kemungkinan field untuk KAS KELUAR
                pengeluaranNum = parseNumber(
                  item.kasKeluar || 
                  item['KAS KELUAR'] ||
                  item.KASKELUAR ||
                  item['Kas Keluar'] ||
                  item.jumlahPengeluaran || 
                  item.pengeluaran ||
                  item.keluar ||
                  item['KELUAR']
                );
                
                // DEBUG: Log kalau masih null untuk KAS
                if (pengeluaranNum === null) {
                  console.log('‚ö†Ô∏è KAS KELUAR NULL - Item:', item);
                  console.log('Available keys:', Object.keys(item));
                }
              }
              
              const pemasukSos = (danaSosialNum !== null && danaSosialNum > 0) ? formatRupiah(danaSosialNum) : '-';
              const pemasukKas = (danaKasNum !== null && danaKasNum > 0) ? formatRupiah(danaKasNum) : '-';
              const pengeluaran = (pengeluaranNum !== null && pengeluaranNum > 0) ? formatRupiah(pengeluaranNum) : '-';
              
              tableHTML += `<td>${item.timestamp}</td><td>${item.tanggal}</td><td>${item.keterangan}</td><td>${item.jenisTransaksi}</td><td>${pemasukSos}</td><td>${pemasukKas}</td><td>${pengeluaran}</td>`;
            } else if (tabType === 'IURAN') {
              const bulanText = Array.isArray(item.bulanDibayar) ? item.bulanDibayar.join(', ') : item.bulanDibayar;
              tableHTML += `<td>${item.timestamp}</td><td>${item.noKK}</td><td>${item.namaWarga}</td><td>${item.alamat}</td><td>${bulanText}</td><td>${item.jumlahBulan}</td><td>${formatRupiah(item.totalPembayaran)}</td>`;
            } else if (tabType === 'ASET') {
              tableHTML += `<td>${item.timestamp}</td><td>${item.namaAset}</td><td>${item.jumlah}</td><td>${item.jenisAset}</td><td>${item.kondisi}</td><td>${item.lokasi}</td><td>${item.tahunBeli}</td><td>${formatRupiah(item.hargaTotal)}</td>`;
            }
            
            tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          historyContainer.innerHTML = tableHTML;
          
          dataCache[tabType.toLowerCase()] = true;
        } else {
          historyContainer.innerHTML = '<div class="loading">Belum ada data</div>';
          dataCache[tabType.toLowerCase()] = true;
        }
      } catch (error) {
        historyContainer.innerHTML = '<div class="loading">Error loading data: ' + error.message + '</div>';
      }
    }

    async function loadWargaList() {
      try {
        const response = await fetch(WEB_APP_URL + '?action=getHistory&tabType=WARGA');
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const wargaMap = new Map();
          result.data.forEach(warga => {
            const namaWarga = warga.namaWarga || warga.nama;
            const noKK = warga.noKK;
            const alamat = warga.alamat;
            
            if (noKK && namaWarga && !wargaMap.has(noKK)) {
              wargaMap.set(noKK, {
                nama: namaWarga,
                noKK: noKK,
                alamat: alamat || '-'
              });
            }
          });
          wargaList = Array.from(wargaMap.values());
        }
      } catch (error) {
        console.error('Error loading warga:', error);
      }
    }

    // Load initial data
    loadHistory('WARGA');
    calculateWargaSummary();
    calculateIuranSummary();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a94ea9de0af4ad3',t:'MTc2NDk1MjEwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>